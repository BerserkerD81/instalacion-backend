services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: api
    # SEGURIDAD: Solo accesible desde el propio servidor (localhost)
    env_file:
      - .env
    environment:
      # Aseguramos que la API sepa dónde está Browserless
      - BROWSER_WS_ENDPOINT=ws://browser:3000
    volumes:
      - uploads_data:/usr/src/app/uploads
    depends_on:
      mysql:
        condition: service_started
      browser:
        condition: service_healthy # Espera a que Chrome esté listo antes de arrancar la API
    networks:
      - instalaciones_network

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: always
    # SEGURIDAD: Solo accesible localmente. Tu Proxy (Nginx/Traefik) debe apuntar a localhost:5678
    ports:
      - "5678:5678"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    environment:
      - NODE_OPTIONS=--dns-result-order=ipv4first
      - TZ=America/Santiago
      - NODE_ENV=production
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_PERSONALIZATION_ENABLED=false
      # SEGURIDAD: Lee estas variables desde el .env, no las escribas aquí
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
      - N8N_HOST=n8n.geonet.cl
      - WEBHOOK_URL=https://n8n.geonet.cl/
      - N8N_PROXY_HOPS=1
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - instalaciones_network

  # --- NUEVO SERVICIO BROWSERLESS ---
  browser:
    image: browserless/chrome:latest
    container_name: browserless
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      # Aumentamos a 2 minutos para que Puppeteer tenga tiempo de pasar el captcha
      - CONNECTION_TIMEOUT=120000
      - MAX_CONCURRENT_SESSIONS=10
      - DEFAULT_STEALTH=true
      - DEFAULT_IGNORE_HTTPS_ERRORS=true
      # SOLUCIÓN AL CRASH: Formato JSON estricto encerrado en comillas simples
# ESTO ESTÁ BIEN:
      - DEFAULT_LAUNCH_ARGS=["--disable-blink-features=AutomationControlled","--no-sandbox","--disable-setuid-sandbox"]    # Vital para que Cloudflare no colapse el contenedor por falta de memoria RAM
    shm_size: '1gb'
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:3000/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - instalaciones_network
  # ----------------------------------
  
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: phpmyadmin
    restart: always
    depends_on:
      - mysql
    environment:
      - PMA_HOST=mysql
      - PMA_PORT=3306
      - PMA_ARBITRARY=0
    # SEGURIDAD EXTREMA: Solo escucha en localhost. 
    # Nadie en internet verá este puerto abierto.
    ports:
      - '127.0.0.1:8081:80'
    networks:
      - instalaciones_network

  mysql:
    image: mysql:8.0
    container_name: mysql
    restart: always
    env_file:
      - .env
    # SEGURIDAD TOTAL: Eliminamos 'ports'. 
    # La base de datos es INVISIBLE para el mundo exterior.
    # Solo 'api', 'n8n' y 'phpmyadmin' pueden conectarse a ella.
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - instalaciones_network
    # Comando recomendado para compatibilidad con n8n y node viejos
    command: --default-authentication-plugin=mysql_native_password

volumes:
  db_data:
  uploads_data:
  n8n_data:

networks:
  instalaciones_network:
    external: true
    name: instalaciones_network